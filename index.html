<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Dolr Payment</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600&display=swap" rel="stylesheet">

<style>
body{
    background:#0f172a;
    font-family:'Cairo',sans-serif;
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
    margin:0;
    color:#fff;
}
.card{
    background:#020617;
    width:360px;
    padding:25px;
    border-radius:14px;
    box-shadow:0 0 40px rgba(0,0,0,.6);
}
h2{
    text-align:center;
    margin-bottom:20px;
}
.input-group{
    margin-bottom:14px;
}
label{
    font-size:13px;
    color:#94a3b8;
}
input{
    width:100%;
    padding:10px;
    border-radius:8px;
    border:1px solid #334155;
    background:#020617;
    color:#fff;
    outline:none;
}
input.error{
    border-color:#ef4444;
}
.error-msg{
    font-size:12px;
    color:#ef4444;
    display:none;
}
button{
    width:100%;
    padding:12px;
    background:#22c55e;
    border:none;
    border-radius:10px;
    color:#022c22;
    font-size:16px;
    cursor:pointer;
}
button:disabled{
    background:#64748b;
}
.status{
    margin-top:15px;
    font-size:14px;
    text-align:center;
}
</style>
</head>

<body>

<div class="card">
    <h2>الدفع الآمن</h2>

    <div class="input-group">
        <label>المبلغ (إجباري)</label>
        <input type="number" id="amount">
        <div class="error-msg" id="err-amount">أدخل مبلغ صحيح</div>
    </div>

    <div class="input-group">
        <label>وصف الطلب (اختياري)</label>
        <input type="text" id="description" placeholder="تفاصيل الطلب">
    </div>

    <div class="input-group">
        <label>البريد الإلكتروني (اختياري)</label>
        <input type="email" id="email" placeholder="name@example.com">
    </div>

    <div class="input-group">
        <label>رقم الجوال (اختياري)</label>
        <input type="tel" id="phone" placeholder="9665xxxxxxxx" maxlength="12">
        <div class="error-msg" id="err-phone">رقم الجوال غير صحيح</div>
    </div>

    <button id="payBtn">ادفع الآن</button>

    <div class="status" id="status"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>

<script>
const CONFIG = {
    MERCHANT_ID: "PUT_MERCHANT_ID_HERE",
    MERCHANT_PASSWORD: "PUT_PASSWORD_HERE",
    API_URL: "https://api.edfapay.com/payment/initiate",
    CURRENCY: "SAR"
};

const statusBox = document.getElementById('status');
const payBtn = document.getElementById('payBtn');

function showStatus(type,msg){
    statusBox.style.color = type === 'error' ? '#ef4444' : '#22c55e';
    statusBox.innerText = msg;
}

payBtn.onclick = async () => {

    const amount = parseFloat(document.getElementById('amount').value);

    const description =
        document.getElementById('description').value.trim() || "Order";

    const email =
        document.getElementById('email').value.trim() || "noemail@dolr-pay.com";

    let phone =
        document.getElementById('phone').value.replace(/\D+/g,'') || "966500000000";

    let isValid = true;

    // مبلغ (إجباري)
    if(isNaN(amount) || amount <= 0){
        document.getElementById('err-amount').style.display='block';
        document.getElementById('amount').classList.add('error');
        isValid = false;
    }else{
        document.getElementById('err-amount').style.display='none';
        document.getElementById('amount').classList.remove('error');
    }

    // بريد (اختياري – تحقق لو كُتب)
    if(email !== "noemail@dolr-pay.com"){
        const emailRegex=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if(!emailRegex.test(email)){
            showStatus('error','صيغة البريد الإلكتروني غير صحيحة');
            return;
        }
    }

    // جوال (اختياري – تحقق لو كُتب)
    if(phone !== "966500000000"){
        if(!/^[0-9]{12}$/.test(phone)){
            document.getElementById('err-phone').style.display='block';
            document.getElementById('phone').classList.add('error');
            isValid = false;
        }else{
            document.getElementById('err-phone').style.display='none';
            document.getElementById('phone').classList.remove('error');
        }
    }else{
        document.getElementById('err-phone').style.display='none';
        document.getElementById('phone').classList.remove('error');
    }

    if(!isValid) return;

    payBtn.disabled = true;
    showStatus('success','جاري إنشاء عملية الدفع...');

    const orderId = "ORD-" + Date.now();

    const hashBase =
        (orderId + amount + CONFIG.CURRENCY + description + CONFIG.MERCHANT_PASSWORD).toUpperCase();

    const md5 = CryptoJS.MD5(hashBase).toString();
    const sha1 = CryptoJS.SHA1(md5).toString();

    const formData = new FormData();
    formData.append("merchant_id", CONFIG.MERCHANT_ID);
    formData.append("order_id", orderId);
    formData.append("amount", amount);
    formData.append("currency", CONFIG.CURRENCY);
    formData.append("order_description", description);
    formData.append("payer_email", email);
    formData.append("payer_phone", phone);
    formData.append("hash", sha1);

    try{
        const res = await fetch(CONFIG.API_URL,{
            method:'POST',
            body:formData
        });
        const data = await res.json();

        if(data.redirect_url){
            window.location.href = data.redirect_url;
        }else{
            showStatus('error','فشل إنشاء عملية الدفع');
            payBtn.disabled=false;
        }

    }catch(e){
        showStatus('error','خطأ في الاتصال');
        payBtn.disabled=false;
    }
};
</script>

</body>
</html>
